

/*********************************************************************************************/
var lastSelectedUser = new Map();
var lastSelectedID = '';
const UPDATE_BUTTON_TEXT = "Update";
const SAVE_BUTTON_TEXT = "Add New User";

/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

function deleteUser(userid) {
  const id = $(userid).attr('id');
  alert(id);
  
}

/*********************************************************************************************/
function editUser(userid) {
  const id = $(userid).attr('id');
  lastSelectedID = id;
  $("#topicHeading").text("Edit User Details");
  $("#btnSaveUser").text(UPDATE_BUTTON_TEXT);
  let arrSelect = lastSelectedUser.get(id);
  $("#addNewUser").val(arrSelect[0]);
   $("#addNewSurname").val(arrSelect[1]);
    $("#addPassword").val(arrSelect[3]);
     $("#addConPassword").val(arrSelect[3]);
      $("#adduserTypes").val(arrSelect[4]);

      
       
  
  
}
/*********************************************************************************************/
function getAllUsers() {
  let tbody = $("#usersList");
  tbody.empty();
  let userLoadingRow = $("#userLoadingRow");
  userLoadingRow.slideDown("fast");
  let userNoDataRow = $("#userNoDataRow");
  userNoDataRow.slideUp("fast");
  let loadingErrorRow = $("#loadingErrorRow");
  loadingErrorRow.slideUp("fast");


  $.get("http://localhost:3500/getUsers")
  .done( (response)=> {
     userLoadingRow.slideUp("fast");
     loadingErrorRow.slideUp("fast");
     if( response.length == 0 ){
       let userNoDataRow = $("#userNoDataRow");
     }else{
        lastSelectedUser.clear();       
       response.forEach(item => { 
        lastSelectedUser.set( item._id ,
          [
            item.name_ , item.surname_ ,  item.date_ ,  item.password , item.level_type
          ]   
        );
        let tr = "<tr> "+
        "<td>"+item.name_+ ' ' + item.surname_+ "</td>"+
        "<td>"+item.level_type+"</td>"+
         "<td>"+ getDateConvertion(item.date_)+"</td>"+
          "<td><a onclick='editUser(this)' id='"+item._id+"' href='javascript:void(0)'> Edit </a> &nbsp; "+
          "<a  onclick='deleteUser(this)' id='"+item._id+"' href='javascript:void(0)'> Del</a> </td>"+
        " </tr> ";
        tbody.append(tr);
       });
     }
  }).fail( (err)=> {
     userLoadingRow.slideUp("fast");
     loadingErrorRow.slideDown("fast");
  });
}
getAllUsers();
/*********************************************************************************************/
function EditUser ( addNewUser ,  addNewSurname , addPassword  , adduserTypes  ) {
  loadingScreen(true , "Saving Edit ");
  $.post("http://localhost:3500/editUSer",{
    lastSelectedID:lastSelectedID ,
    name_: addNewUser ,
   surname_: addNewSurname ,
    password :addPassword ,   
   level_type: adduserTypes 
  }).done(response =>{
    loadingScreen(false , "Saving Edit ");
      if(response == 'done'  ){
            getAllUsers();
            $("#btnSaveUser").text(SAVE_BUTTON_TEXT);
            $("#topicHeading").text("Add Users");
      }else{
        showErrorMessage("Failed to edit the Users details" , 4500);
      }
  }).fail(error=>{
     loadingScreen(false , "Saving Edit ");
     console.log(error);     
     showErrorMessage("An error occurres in the background !" , 4500);

  });
}
/*********************************************************************************************/
function saveNewUser ( addNewUser ,  addNewSurname , addPassword  , adduserTypes ) {
   loadingScreen(true , "Saving ");
 $.post("http://localhost:3500/addUser",{
   name_: addNewUser ,
   surname_: addNewSurname ,
    password :addPassword ,   
   level_type: adduserTypes 
 }).done(function (response) {
    loadingScreen(false , "Saving ");
    if( response == "done" ){
        showSuccessMessage("Saved " , 3200);
        $("#addNewUser").val("");
        $("#addNewSurname").val("");
        $("#addPassword").val("");
        $("#adduserTypes").val("null");
        getAllUsers();
    }else{
      showErrorMessage("Failed to save, Try again" , 5000);
    }
 }).fail(function (error) {
    loadingScreen(false , "Saving ");
     showErrorMessage("Server Error, Failed to save, Try again" , 4000);
 });
}
/*********************************************************************************************/
$("#btnSaveUser").click(function () {
  let addNewUser = _v("addNewUser").trim();
  let addNewSurname = _v("addNewSurname").trim();
  let addPassword = _v("addPassword").trim();
  let addConPassword = _v("addConPassword").trim();
  let adduserTypes = _v("adduserTypes");
  
  if( addNewUser == '' ){
    showErrorMessage("Name cant be empty" , 3400);
    return;
  }
  if( addNewSurname == '' ){
    showErrorMessage("Surname cant be empty" , 3400);
    return;
  }
   if( addPassword == '' ){
    showErrorMessage("Password cant be empty" , 3400);
    return;
  }
   if( addConPassword == '' ){
    showErrorMessage("Confirm password" , 3400);
    return;
  }

  if( addConPassword !== addPassword ){
    showErrorMessage("Password and Confirm Password have to be the same " , 3400);
    return;
  }

   if( adduserTypes == 'null' ){
    showErrorMessage("Please set user Level" , 3400);
    return;
  }
  if($(this).text() == UPDATE_BUTTON_TEXT ) {
      EditUser(   addNewUser ,  addNewSurname , addPassword  , adduserTypes   );
  }else{
    saveNewUser(   addNewUser ,  addNewSurname , addPassword  , adduserTypes   );
  }
 
});

/*********************************************************************************************/
$("#Btnsave").click(function(){
  let classesNames = $('.select2-A').val(); 
  let min = ($("#fromClassLevel").val().trim());
  let max = ($("#toClassLevel").val().trim());

  let classLevels = min + '-' + max ;

  if(classesNames ==''){
    showErrorMessage("Please Select Class at least 1." , 4000);
    return ;
  }
  classesNames = classesNames + '';

  loadingScreen(true , "Saving ");
  $.post("http://localhost:3500/getStudentSaveGrade",{
     classesNames:classesNames,
    classLevels:classLevels 
   
  },function(response){
    loadingScreen(false , "Saving ");
      if( response == 'done' ){
          showSuccessMessage("Saved Successfully" , 12000);
          $("#System_NotificationPanel").slideDown();
      }else{
        alert(response);
        showErrorMessage("Failed to save . Please try again." , 4000);
      }
  });
 
});
/*********************************************************************************************/

 $(".select2-A").select2({
      placeholder: "Select Class Names",
      allowClear: true,

    });
//$(".select2-A").val(["Blue","Red"]).select2({allowClear: true,});

/*********************************************************************************************/

//var range = document.getElementById('Graderange');
$("#fromClassLevel").change(function(){
    let min = parseInt($(this).val().trim());
    let max = parseInt($("#toClassLevel").val().trim());

    
  if (min > max) {
    $(this).val(max);
    $("#toClassLevel").val(min);
  } else if (min == max) {
    $("#toClassLevel").val(max + 1);
  } else {
    $(this).val(min);
    $("#toClassLevel").val(max);
  }
   

});

$("#toClassLevel").change(function(){
   let max = parseInt($(this).val().trim());
   let min = parseInt($("#fromClassLevel").val().trim());

 
  if (max < min) {
    $("#fromClassLevel").val(max);
    $("#toClassLevel").val(min)
  } else if (min == max) {
    $("#fromClassLevel").val(min - 1);
  }

});

  
/*********************************************************************************************/

/*var range = $("#Graderange");
$range.ionRangeSlider({
    type: "single",
    grid: true,
    min: 10000,
    max: 10000000,
    from: 10000,
    prettify_separator: ",",
    onStart: function(data) {
		$result.text(prettify(data.from));
    },
    onChange: function(data) {
		$result.text(prettify(data.from));
    }
});*/


/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/
function prettify(num) {
    var n = num.toString();
    return n.replace(/(\d{1,3}(?=(?:\d\d\d)+(?!\d)))/g, "$1" + ",");
}

/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/




/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/




/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/




/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/




/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/




/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/


/*********************************************************************************************/

/*********************************************************************************************/

